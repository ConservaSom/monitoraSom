---
title: "Template Matching Notes"
author: "GLMRosa"
format: pdf
---

Validation app
- Novos defaults para os seguintes argumentos:
  - dyn_range_templ = c(-84, 0)
  - dyn_range_detec = c(-84, 0)
  - auto_next = TRUE
  - nav_autosave = TRUE
- Argumento `min_score` substituido por `score_interval`, que é um vetor com os valores mínimo e máximo de score para a seleção de detecções.
- Novas opções para o setup das detecções a serem validadas:
  - "Top detections" - filtra as n detecções com os maiores scores para que sejam validadas
  - "Search top scores within soundscape files" - faz a busca dos n maiores scores dentro de soundscape se marcado, se não, busca os n maiores scores em todo o conjunto de detecções
  - "Order by" - ordena as detecções por arquivo e score em diferentes combinações, incluindo aleatoriamente
  - "Seed for random subsetting" - seed para a seleção aleatória de detecções agora está como parte do setup, e não mais no menu de validação
- Recall agora é referido como relative recall nos plots e tabelas para melhor ajuste conceitual
- Foi adicionado um plot de densidade no painel de diagnósticos para melhor visualização da distribuição dos scores
- bug solved - rows_patch dava problema quando overwrite = FALSE
- bug solved - Agora quando o setup do template não retorna nenhuma detecção é acionada uma pop up avisando ao inves de travar o app



- adicionar um menu com o nome da espécie com cadeado
- Segunda camada de classificação para mitigação de falsos positivos ou desambiguação entre espécies com cantos similares

- next unsegmented no app de segmentação não está navegando direito

- Mostrar a probabilidade do modelo binomial quando disponivel (Deixar pra depois pq depender de atualizações independentes do modelo exige um pouco mais de cuidado pra prevenir bugs)

Prioridades
- Implementar o restante dos diagnósticos
- A validação deve retornar 3 objetos: o valor do score selecionado, a tabela de diagnosticos baseados nesse score e a tabela de detecs validadas.

Funções
- Fazer uma função para extração dos metadados a partir de nomes de arquivos e metadados de arquivos audiomoths e sm4
- Fazer uma função para adaptar um corte de audio qualquer como template
- Fazer função para conversão entre tabelas de seleção do raven, birdnet e audacity para roi_tables
  - Criar funções para que sejam convertidas tabelas de seleção do Raven e Audacity para o formato de output do app de segmentação
- Deprecate roi tables como formato de templates
- Função de match_n tem que checar o caminho para o salvamento antes de processar tudo
- Implementar função de diagnóstico de template

Geral
- Adicionar contador de tempo para as funções de processamento mais longo
- pasta data/ com objetos para exemplos de todas as funções
  - (Um exemplo de três templates e três soundscapes para o template matching
  - uma tabelona com detecções para exemplo de validação
  - link estável para baixar dados de exemplos maiores
  - Fazer um Rdata que exporta os arquivos para um diretório de exemplo
- remover as paradas do vs code do repo
- Adicionar opções gerais para seleção e registro do canal onde cada processo foi feito

Apps
- Adicionar autoplay onde puder ser necessário
- Adicionar checkbox para inversão das escalas de cores dos sonogramas
- Simplificar o app com a remoção de seções duplicadas do código para acesso por diferentes tipos de inputs, como hotkeys e actionButtons ao mesmo tempo.
- Streaming dos dados em um banco de dados em SQL
- Adicionar opção para selecionar o canal do sonograma visível
- Encontrar e resolver o bug de renderização duplicada dos sonogramas
- Fazer um painel com metadados da soundscape em ambos os apps
- Validação:
  - fazer 'play' como 'R session' funcionar em windows
  - Fazer um segundo conjunto de dados de demonstração, maior para varificar questões de performance
  - Adicionar seed específica para os diagnósticos
  - Modificar o sistema para que seja possível haver mais de uma validação por detecção, caso seja um usuário diferente.
  - Habilitar a navegaçao entre soundscapes
- Segmentação
  - Ativar mecanismo de detecção de sistema para os players
    - Detectar se o sox está disponível?
    - Pedir caminho para o player quando houver "R session" no windows
    - Apresentar erro de detecção se o sox não estiver disponível no linux ou no mac
  - verificar os padrões usados em https://esajournals.onlinelibrary.wiley.com/doi/10.1002/ecy.3329
  - Progresso
    - Rever o que é informado na barra de progresso
    - Alimentar uma unica tabela ao inves de uma tabela por arquivo?
  - Adicionar um campo com uma lista em que persistem as tags mais usadas em ordem aflabética que possam ser clicadas facilmente para preencher todos os campos (exceto a observação). Essas opções devem ser clicáveis.

fetch_score_peaks_i()
- Verificar se `fetch_score_peaks_i()` deve desligar um dado filtro e retornar todas as detecções no caso de não restar nenhuma detecção após o filtro. Valeria a pena fazer a função retornar um dataframe vazio?

fetch_score_peaks_n()
- Adicionar paralelização

Funções novas
- Fazer uma terceira função com o split e serialização de batches muito grandes para salvamento em multiplos arquivos rds ou uma alternativa para streaming dos resultados para uma base de dados onde seja possível fazer a consulta de ter ou não sido feito o mesmo template matching antes do processamento para evitar a duplicação de resultados ou processamento desnecessário.
- Criar a função set_paths() com checagens para facilitar a definição dos diretórios



### Perguntas importantes
- Quais são os efeitos dos filtros de detecções baseados nos scores sobre os diagnosticos?
- Como lidar com multiplas validações de usuários diferentes para um mesmo conjunto de detecções? Como processar % de TP e FP para os diagnósticos?
- Qual é o efeito dos pads de tempo e frequência para a detecção?
- Quais são as espécies que quando aparecem na gravação fazer o usuário demorar mais pra segmentar?

### Para depois
- App de segmentação
  - Player focal
    - ROIs selecionadas na tabela são concatenadas e tocadas em sequência
    - Caso não haja nenhuma selecionada, toca a mais recente
    - Adicionar checkbox para aplicar filtros de banda sobre os sons tocados
  - Dar ao usuário a possibilidade de editar o nome da tabela de rois?
  - Escolha entre segmentação com atribuição prévia ou posterior dos metadados de cada roi. No modo de atribuição posterior, inputs são dados em uma pop-up, sendo que o usuário tem a opção de omitir essa pop-up repetindo os metadados atribuídos anteriormente. Isso permitiria um modelo de edição de rois ativas similar à do Raven.
  - bug das Renderização duplicada de sonograma
    - O processamento das ROIs disponíveis acaba depois da renderização, fazendo com que seja feita a renderização uma segunda vez para inclui-las
  - Adicionar um sonograma de panorama para navegar no da soundscape
  - Usar o file input como alternativa quando o app é usado de forma local, carregando diretamente os múltiplos arquivos que serão segmentados. Talvez seja interessante ter modos remoto e local



