---
title: "Template Matching Notes"
author: "GLMRosa"
format: pdf
---

`monitoraSom`:
-`match_i` -
  - A função `match_i()` recebeu a opção de retornar scores (`output = "scores"`) ou detecções (`output = "detections"`), permitindo que o usuário escolha o tipo de output que deseja obter.
- `match_n` - O processo interno dessa função foi completamente remodelado
  - Foram adicionadas opções para que o usuário possa escolher se quer "scores", que é o output puro da função `match_i()`, ou "detections", que é o output da função `fetch_score_peaks_n()`. A escolha de "detections" foi habilitada para diminuir o tamanho dos resultados e resolver os problemas de escalabilidade da função `match_n()` original.
  - Foi dada ao usuário a escolha entre manter o resultado dentro do ambiente do R ou salvar em forma de arquivo RDS para "scores" e CSV para "detections".
  - O salvamento em CSV habilitado para "detections" foi desenvolvido de forma que as detecções obtidas a cada iteração sejam salvas diretamente no arquivo CSV, evitando a necessidade de armazenar a totalidade dos resultados na memória. O usuário tem ainda a opção de controlar autosave_action = "append" ou autosave_action = "replace", que permite adicionar novas detecções ao arquivo CSV ou substituir o arquivo existente, respectivamente. Recomenda-se o uso de autosave_action = "append" para evitar a perda de dados, mas o usuário deve estar atento para evitar a retenção de eventuais detecções duplicadas entre diferentes rodadas.
  - Todos os argumentos da função `find_score_peaks_n()` foram passados para a função `match_n()`, permitindo que o usuário possa filtrar os resultados de acordo com os scores obtidos.
  - Foram adicionads mensagens de texto para que o usuário se oriente em relação ao tipo de output escolhido.
- Nova função `export_roi_cuts_n` feita para exportar cortes em formato WAV de todas as ROIs de uma tabela produzida pelo app de segmentação. A função recebe como argumentos a tabela de ROIs e o diretório de saída dos cortes. Assume-se que os caminhos para os arquivos de audio na tabela de ROIs sejam válidos localmente para que possam ser lidos.
- `launch_segmentation_app()`
  - Correções nos gráficos de diagnósticos e remoção da curva ROC.
  - Substituição interna do processo de exportar cortes pela função `export_roi_cuts_n()`.
- 


- adicionar um menu com o nome da espécie com cadeado
- Segunda camada de classificação para mitigação de falsos positivos ou desambiguação entre espécies com cantos similares

- next unsegmented no app de segmentação não está navegando direito

- Mostrar a probabilidade do modelo binomial quando disponivel (Deixar pra depois pq depender de atualizações independentes do modelo exige um pouco mais de cuidado pra prevenir bugs)

Prioridades
- Implementar o restante dos diagnósticos
- A validação deve retornar 3 objetos: o valor do score selecionado, a tabela de diagnosticos baseados nesse score e a tabela de detecs validadas.

Funções
- Fazer uma função para extração dos metadados a partir de nomes de arquivos e metadados de arquivos audiomoths e sm4
- Fazer uma função para adaptar um corte de audio qualquer como template

- Deprecate roi tables como formato de templates
- Função de match_n tem que checar o caminho para o salvamento antes de processar tudo
- Implementar função de diagnóstico de template

Geral
- Adicionar contador de tempo para as funções de processamento mais longo
- pasta data/ com objetos para exemplos de todas as funções
  - (Um exemplo de três templates e três soundscapes para o template matching
  - uma tabelona com detecções para exemplo de validação
  - link estável para baixar dados de exemplos maiores
  - Fazer um Rdata que exporta os arquivos para um diretório de exemplo
- remover as paradas do vs code do repo
- Adicionar opções gerais para seleção e registro do canal onde cada processo foi feito

Apps
- Adicionar autoplay onde puder ser necessário
- Adicionar checkbox para inversão das escalas de cores dos sonogramas
- Simplificar o app com a remoção de seções duplicadas do código para acesso por diferentes tipos de inputs, como hotkeys e actionButtons ao mesmo tempo.
- Streaming dos dados em um banco de dados em SQL
- Adicionar opção para selecionar o canal do sonograma visível
- Encontrar e resolver o bug de renderização duplicada dos sonogramas
- Fazer um painel com metadados da soundscape em ambos os apps
- Validação:
  - fazer 'play' como 'R session' funcionar em windows
  - Fazer um segundo conjunto de dados de demonstração, maior para varificar questões de performance
  - Adicionar seed específica para os diagnósticos
  - Modificar o sistema para que seja possível haver mais de uma validação por detecção, caso seja um usuário diferente.
  - Habilitar a navegaçao entre soundscapes
- Segmentação
  - Ativar mecanismo de detecção de sistema para os players
    - Detectar se o sox está disponível?
    - Pedir caminho para o player quando houver "R session" no windows
    - Apresentar erro de detecção se o sox não estiver disponível no linux ou no mac
  - verificar os padrões usados em https://esajournals.onlinelibrary.wiley.com/doi/10.1002/ecy.3329
  - Progresso
    - Rever o que é informado na barra de progresso
    - Alimentar uma unica tabela ao inves de uma tabela por arquivo?
  - Adicionar um campo com uma lista em que persistem as tags mais usadas em ordem aflabética que possam ser clicadas facilmente para preencher todos os campos (exceto a observação). Essas opções devem ser clicáveis.

fetch_score_peaks_i()
- Verificar se `fetch_score_peaks_i()` deve desligar um dado filtro e retornar todas as detecções no caso de não restar nenhuma detecção após o filtro. Valeria a pena fazer a função retornar um dataframe vazio?

fetch_score_peaks_n()
- Adicionar paralelização

Funções novas
- Fazer uma terceira função com o split e serialização de batches muito grandes para salvamento em multiplos arquivos rds ou uma alternativa para streaming dos resultados para uma base de dados onde seja possível fazer a consulta de ter ou não sido feito o mesmo template matching antes do processamento para evitar a duplicação de resultados ou processamento desnecessário.
- Criar a função set_paths() com checagens para facilitar a definição dos diretórios



### Perguntas importantes
- Quais são os efeitos dos filtros de detecções baseados nos scores sobre os diagnosticos?
- Como lidar com multiplas validações de usuários diferentes para um mesmo conjunto de detecções? Como processar % de TP e FP para os diagnósticos?
- Qual é o efeito dos pads de tempo e frequência para a detecção?
- Quais são as espécies que quando aparecem na gravação fazer o usuário demorar mais pra segmentar?

### Para depois
- App de segmentação
  - Player focal
    - ROIs selecionadas na tabela são concatenadas e tocadas em sequência
    - Caso não haja nenhuma selecionada, toca a mais recente
    - Adicionar checkbox para aplicar filtros de banda sobre os sons tocados
  - Dar ao usuário a possibilidade de editar o nome da tabela de rois?
  - Escolha entre segmentação com atribuição prévia ou posterior dos metadados de cada roi. No modo de atribuição posterior, inputs são dados em uma pop-up, sendo que o usuário tem a opção de omitir essa pop-up repetindo os metadados atribuídos anteriormente. Isso permitiria um modelo de edição de rois ativas similar à do Raven.
  - bug das Renderização duplicada de sonograma
    - O processamento das ROIs disponíveis acaba depois da renderização, fazendo com que seja feita a renderização uma segunda vez para inclui-las
  - Adicionar um sonograma de panorama para navegar no da soundscape
  - Usar o file input como alternativa quando o app é usado de forma local, carregando diretamente os múltiplos arquivos que serão segmentados. Talvez seja interessante ter modos remoto e local
  - Tentei otimizar o match_n para que as leituras dos wavs e a computação dos sonogramas pudesse ser reaproveitada, mas somente a primeira parte pareceu possivel. A forma como os templates são criados precisa ser modificada para que sonogramas das soundscapes possam ser reaproveitados sem bugs. O problema está no ajuste perfeito das dimensões geradas entre os sonograma das soundscapes e dos templates.



